

# 思路

长时间的控制？
- 保证原始的payload要足够稳定
- 保证payload的多次触发

权限维持：重新启动、开机过程中触发
>了解目标在打开计算机后最常使用的软件或者实施的行为

## 重点
维持
用户常用的计算机操作： 鼠标右键

```cardlink
url: https://github.com/RistBS/ContextMenuHijack
title: "GitHub - RistBS/ContextMenuHijack: Execute a payload at each right click on a file/folder in the explorer menu for persistence"
description: "Execute a payload at each right click on a file/folder in the explorer menu for persistence - RistBS/ContextMenuHijack"
host: github.com
favicon: https://github.githubassets.com/favicons/favicon.svg
image: https://opengraph.githubassets.com/629e0ef9ab8aaa1c138d8607aa0b33a0befbf1f0cb0b4a5ebcb2f99ab44e3dd7/RistBS/ContextMenuHijack
```


# 开机顺序

>Windows操作系统在启动时会经历一系列复杂的步骤，这些步骤确保了系统能够顺利地加载并运行所需的服务和应用程序。以下是Windows操作系统开机时各个组件的大致启动顺序：

1. **BIOS（基本输入输出系统）**：  
    开机时，计算机首先执行BIOS，它负责进行硬件检测，包括CPU、内存、硬盘等，并初始化硬件设备。
2. **MBR（主引导记录）**：  
    BIOS检查完成后，它会读取存储在硬盘上的MBR，MBR包含启动管理器，负责加载操作系统的引导程序。
3. **Boot Manager（启动管理器）**：  
    启动管理器负责确定哪个操作系统或启动选项将被加载。在多系统安装的情况下，它会显示一个启动菜单供用户选择。  ![](media/Pasted%20image%2020250806170817.png) 
4. **Boot Loader（引导程序）**：  
    选择操作系统后，引导程序（如Windows的Bootmgr或Grub）会加载并开始操作系统的启动过程。
5. **Kernel（内核）**：  
    引导程序加载操作系统的核心组件，即内核。内核是操作系统的核心，负责管理系统资源和控制硬件。内核空间的界定和内容的初始化
6. **System Initialization（系统初始化）**：  
    内核加载后，会进行系统初始化，包括加载系统服务和驱动程序。
7. **Device Drivers（设备驱动程序）**：  
    系统初始化的一部分是加载设备驱动程序，这些程序允许操作系统与硬件设备进行通信。
8. **User Login（用户登录）winlogon.exe**：  
    系统初始化完成后，会显示登录界面，用户需要输入用户名和密码来登录系统。
9. **User Session（用户会话）**：  
    用户登录后，系统会加载用户的配置文件和启动用户会话。这包括加载用户特定的设置、启动应用程序和桌面环境。
10. **Startup Applications（启动应用程序）**：  
    最后，系统会启动在启动时配置的应用程序，这些应用程序可以是系统级的服务或用户特定的应用程序。

这个顺序是一个高层次的概述，实际的启动过程可能会根据具体的硬件配置、操作系统版本和用户设置有所不同。此外，现代Windows操作系统（如Windows 10和Windows 11）采用了快速启动（Fast Startup）功能，该功能通过保存系统状态来减少启动时间，这可能会改变上述步骤的某些细节。


# 具体操作

[https://xz.aliyun.com/t/8095](https://xz.aliyun.com/t/8095)
## 注册表
- 注册表的思路：所有值是带有pe文件的都可以操作
- 防止意外：
	- `cmd.exe /c " 源程序 & shellcode.exe"` 可以尝试
	- 单独创建进程
		- shellcode执行
		- 源程序

[https://pentestlab.blog/2020/01/14/persistence-winlogon-helper-dll/](https://pentestlab.blog/2020/01/14/persistence-winlogon-helper-dll/)


### run
- `HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`
- `HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce`


[运行和 RunOnce 注册表项 - Win32 apps | Microsoft Learn](https://learn.microsoft.com/zh-cn/windows/win32/setupapi/run-and-runonce-registry-keys)

### 屏幕保护程序

计算机\HKEY_CURRENT_USER\Control Panel\Desktop
## com对象

[https://blog.f-secure.com/abusing-windows-library-files-for-persistence/](https://blog.f-secure.com/abusing-windows-library-files-for-persistence/)



## 计划任务
- 可以用最高权限
[Task Scheduler for developers - Win32 apps | Microsoft Learn](https://learn.microsoft.com/zh-cn/windows/win32/taskschd/task-scheduler-start-page)

## 映像劫持

[隐蔽后门——Image File Execution Options新玩法-安全客 - 安全资讯平台 (anquanke.com)](https://www.anquanke.com/post/id/151425)

## 服务
- System权限

1. `sc create TimeSync binPath= "C:\Windows\System32\svchost.exe -k netsvr" start= auto obj= LocalSystem`
2. `reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync\Parameters /v ServiceDll /t REG_EXPAND_SZ /d "C:\Users\hunter\Desktop\localService32.dll" /f /reg:64`
3. `reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync /v Description /t REG_SZ /d "Windows Time Synchronization Service" /f /reg:64`
4. `reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync /v DisplayName /t REG_SZ /d "TimeSyncSrv" /f /reg:64`
5. `reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost" /v netsvr /t REG_MULTI_SZ /d TimeSync /f /reg:64`
6. `sc start TimeSync`

## aedebug(崩溃时触发)

[https://learn.microsoft.com/zh-cn/windows/win32/debug/configuring-automatic-debugging](https://learn.microsoft.com/zh-cn/windows/win32/debug/configuring-automatic-debugging)

HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AeDebug

## 组策略拓展

HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\GPExtensions

[https://learn.microsoft.com/zh-cn/previous-versions/windows/desktop/policy/creating-a-policy-callback-function](https://learn.microsoft.com/zh-cn/previous-versions/windows/desktop/policy/creating-a-policy-callback-function)

[https://learn.microsoft.com/en-us/archive/blogs/mempson/group-policy-client-side-extension-list](https://learn.microsoft.com/en-us/archive/blogs/mempson/group-policy-client-side-extension-list)

## 搜索过滤

计算机\HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Excel.CSV\shell\Open\command

[https://learn.microsoft.com/zh-cn/windows/win32/search/-search-ifilter-about#ifilter-dlls](https://learn.microsoft.com/zh-cn/windows/win32/search/-search-ifilter-about#ifilter-dlls)

[PSBits/IFilter at master · gtworek/PSBits (github.com)](https://github.com/gtworek/PSBits/tree/master/IFilter)

## 磁盘清理

[https://www.hexacorn.com/blog/2018/09/02/beyond-good-ol-run-key-part-86/](https://www.hexacorn.com/blog/2018/09/02/beyond-good-ol-run-key-part-86/)

[https://www.hexacorn.com/blog/2017/01/18/beyond-good-ol-run-key-part-55/](https://www.hexacorn.com/blog/2017/01/18/beyond-good-ol-run-key-part-55/)

## amsi

[https://github.com/gtworek/PSBits/tree/master/FakeAMSI](https://github.com/gtworek/PSBits/tree/master/FakeAMSI)

[https://learn.microsoft.com/zh-cn/windows/win32/amsi/dev-audience](https://learn.microsoft.com/zh-cn/windows/win32/amsi/dev-audience)

## 服务插件

[https://github.com/gtworek/PSBits/tree/master/ServerLevelPluginDll](https://github.com/gtworek/PSBits/tree/master/ServerLevelPluginDll)

## lsa拓展

[https://x.com/0gtweet/status/1476286368385019906](https://x.com/0gtweet/status/1476286368385019906)

HKLM\SYSTEM\CurrentControlSet\Control\LsaExtensionConfig\LsaSrv

## 命令行

[https://nasbench.medium.com/persistence-using-windows-terminal-profiles-5035d3fc86fe](https://nasbench.medium.com/persistence-using-windows-terminal-profiles-5035d3fc86fe)

## 开机启动文件夹

%appdata%\Microsoft\Windows\Start Menu\Programs\Startup

## **Autodial DLL**

[https://www.hexacorn.com/blog/2015/01/13/beyond-good-ol-run-key-part-24/](https://www.hexacorn.com/blog/2015/01/13/beyond-good-ol-run-key-part-24/)

## 静默退出

1. `$monitoredApp = "notepad.exe"`
2. `$monitor = "powershell -c calc.exe #"`

3. `New-Item -Force -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\$monitoredApp" | Out-Null`
4. `Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\$monitoredApp" -Name GlobalFlag -Value 512`

5. `New-Item -Force -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\$monitoredApp" | Out-Null`
6. `Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\$monitoredApp" -Name ReportingMode -Value 1`
7. `Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\$monitoredApp" -Name MonitorProcess -Value $monitor`



## office

[https://infocondb.org/con/def-con/def-con-25/persisting-with-microsoft-office-abusing-extensibility-options](https://infocondb.org/con/def-con/def-con-25/persisting-with-microsoft-office-abusing-extensibility-options)

[https://www.mdsec.co.uk/2019/01/abusing-office-web-add-ins-for-fun-and-limited-profit/](https://www.mdsec.co.uk/2019/01/abusing-office-web-add-ins-for-fun-and-limited-profit/)

## DLL劫持

[https://www.bilibili.com/video/BV18q4y1j7NF/](https://www.bilibili.com/video/BV18q4y1j7NF/)

[https://www.bilibili.com/video/BV1qV41187Fh/](https://www.bilibili.com/video/BV1qV41187Fh/)

## 插件

[https://pentestlab.blog/2022/02/14/persistence-notepad-plugins/](https://pentestlab.blog/2022/02/14/persistence-notepad-plugins/)