#codeview #codeql
#ä»£ç å®¡è®¡ 

>é™æ€åˆ†æï¼ˆé™æ€ä»£ç åˆ†ææˆ–é™æ€ç¨‹åºåˆ†æï¼‰æ˜¯ä¸€ç§æ— éœ€æ‰§è¡Œä»£ç æœ¬èº«å³å¯åˆ†æåº”ç”¨ç¨‹åºä»£ç ä»¥å‘ç°æ½œåœ¨é”™è¯¯çš„è¿‡ç¨‹ã€‚è¯¥æŠ€æœ¯å¯ç”¨äºæ‰§è¡Œå„ç§æ£€æŸ¥ã€éªŒè¯å¹¶çªå‡ºæ˜¾ç¤ºä»£ç ä¸­çš„é—®é¢˜ã€‚åœ¨GitHubï¼Œæˆ‘ä»¬é€šè¿‡è¯­ä¹‰åˆ†æå¼•æ“CodeQLè¿›è¡Œä»£ç æ‰«ææ¥å®ç°é™æ€åˆ†æã€‚
![](media/GitHub-Security-Lab.webp)  

## æ¼æ´æ£€æµ‹ -- sources and sinks

- é™æ€åˆ†ææ“…é•¿æ£€æµ‹çš„ä¸€ç±»æ¼æ´æ˜¯==æ³¨å…¥æ¼æ´==ï¼Œè¿™ç±»æ¼æ´åŒ…å«æ•°åç§å­ç±»å‹
- æ³¨å…¥æ¼æ´çš„**æ ¸å¿ƒæˆå› **åœ¨äºï¼šç¨‹åºå°†ä¸å—ä¿¡ä»»çš„ç”¨æˆ·å¯æ§è¾“å…¥ä¼ é€’ç»™äº†æ•æ„Ÿæˆ–å±é™©å‡½æ•°ã€‚åœ¨é™æ€åˆ†æä¸­ï¼Œæˆ‘ä»¬ç”¨**æ•°æ®æµ**ï¼ˆdata flowï¼‰ã€**æºç‚¹**ï¼ˆsourcesï¼‰å’Œ**æ±‡ç‚¹**ï¼ˆsinksï¼‰ç­‰æœ¯è¯­æ¥æè¿°è¿™ä¸€è¿‡ç¨‹ã€‚
- ç”¨æˆ·è¾“å…¥é€šå¸¸æ¥è‡ªåº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹â€”â€”å³æ•°æ®çš„æºå¤´ã€‚ä¾‹å¦‚HTTPè¯·æ±‚çš„GET/POSTå‚æ•°ï¼Œæˆ–ç¨‹åºçš„å‘½ä»¤è¡Œå‚æ•°ï¼Œè¿™äº›éƒ½è¢«ç§°ä¸º **"æºç‚¹"(sources)**ã€‚
- ä»¥SQLæ³¨å…¥ä¸ºä¾‹ï¼ŒPythonä¸­MySQLdbåº“çš„`MySQLCursor.execute()`æ–¹æ³•ï¼Œæˆ–æ˜¯èƒ½æ‰§è¡Œä»»æ„è¡¨è¾¾å¼çš„å†…ç½®å‡½æ•°`eval()`ï¼Œéƒ½å±äºè‹¥æœªç»å‡€åŒ–ç›´æ¥ä¼ å…¥ä¸å¯ä¿¡æ•°æ®å°±ä¼šå¼•å‘å±é™©çš„å‡½æ•°ï¼Œè¿™ç±»é«˜å±å‡½æ•°è¢«ç§°ä¸º **"æ±‡ç‚¹(sinks)"**ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‡½æ•°æœ¬èº«å…·æœ‰å±é™©æ€§å¹¶ä¸ç­‰åŒäºå¿…ç„¶å­˜åœ¨å¯è¢«åˆ©ç”¨çš„æ¼æ´â€”â€”è®¸å¤šæ±‡ç‚¹é€šè¿‡æ­£ç¡®ä½¿ç”¨å®Œå…¨å¯ä»¥è§„é¿é£é™©ã€‚
- åªæœ‰å½“æœªå‡€åŒ–çš„ç”¨æˆ·å¯æ§è¾“å…¥é€šè¿‡ä»£ç è·¯å¾„ç›´è¾¾å±é™©å‡½æ•°æ—¶ï¼Œæ¼æ´æ‰ä¼šçœŸæ­£å½¢æˆã€‚æ¢è¨€ä¹‹ï¼Œå¿…é¡»å­˜åœ¨ä»æºç‚¹åˆ°æ±‡ç‚¹çš„å®Œæ•´**æ•°æ®æµ**è·¯å¾„ã€‚  
	- ä¸¾ä¸ªğŸŒ°ï¼šè‹¥Djangoæ¡†æ¶ä¸­é€šè¿‡GETè¯·æ±‚è·å–çš„ç”¨æˆ·å¯æ§å‚æ•°ï¼Œæœªç»å¤„ç†å°±ç›´æ¥ä¼ å…¥MySQLdbåº“çš„`cursor.execute()`å‡½æ•°ï¼Œå°±å¯èƒ½å¼•å‘SQLæ³¨å…¥ã€‚![](media/codeql2.webp)
	- å†ä¸¾ä¸ªğŸŒ°ï¼šåœ¨ç”¨æˆ·è¾“å…¥è¡¨å•ä¸­ï¼Œè‹¥å°†POSTè¯·æ±‚çš„å‚æ•°ç›´æ¥ä¼ é€’ç»™`eval()`å‡½æ•°æ‰§è¡Œï¼Œåˆ™å¯èƒ½å¯¼è‡´ä»£ç æ³¨å…¥æ¼æ´ã€‚



## å¯»æ‰¾ sources and sinks

æ—¢ç„¶å·²çŸ¥æ¼æ´é€šè¿‡**æºç‚¹**ï¼ˆsourcesï¼‰è¿›å…¥ç¨‹åºï¼Œå¹¶åœ¨**æ±‡ç‚¹**ï¼ˆsinksï¼‰è§¦å‘æ‰§è¡Œï¼Œæˆ‘ä»¬å¯é€šè¿‡ä¸¤ç§è·¯å¾„æ£€æµ‹æ¼æ´ï¼š  
1ï¸âƒ£ **æ­£å‘è¿½è¸ª**ï¼šä»æºç‚¹å‡ºå‘ï¼Œåˆ†ææ•°æ®æ˜¯å¦æµå‘æ•æ„Ÿå‡½æ•°ï¼ˆæ±‡ç‚¹ï¼‰  
2ï¸âƒ£ **é€†å‘æº¯æº**ï¼šä»æ±‡ç‚¹å›æº¯ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æœªå‡€åŒ–çš„æºç‚¹æ•°æ®æµå…¥  

ä¾‹å¦‚ï¼Œåœ¨Python Djangoé¡¹ç›®ä¸­æ‰‹åŠ¨æ£€æµ‹æ—¶ï¼Œå¯ä½¿ç”¨`grep`å·¥å…·æœç´¢`request.GET`ç­‰æºç‚¹ï¼š  
```python
username = request.GET.get("username")  # æ­£ç¡®åŒ¹é…çš„æºç‚¹ç¤ºä¾‹
```  
ä½†æ­¤æ–¹æ³•å­˜åœ¨ä¸¤å¤§ç—›ç‚¹ï¼š  

**ç—›ç‚¹ä¸€ï¼šå™ªå£°å¹²æ‰°**  
`grep`ä¼šåŒæ—¶åŒ¹é…æ— å…³å†…å®¹ï¼š  
```python
def request_check(req): ...          # è¯¯æŠ¥ï¼šæ— å®³å‡½æ•°å  
# This processes a request from the server    # è¯¯æŠ¥ï¼šæ³¨é‡Šä¸­çš„å…³é”®è¯  
```  
å¯¼è‡´å¤§é‡**è¯¯æŠ¥ï¼ˆfalse positivesï¼‰**ï¼Œéœ€äººå·¥äºŒæ¬¡ç­›é€‰ã€‚  

**ç—›ç‚¹äºŒï¼šè¦†ç›–èŒƒå›´æœ‰é™**  
- å•æ¬¡ä»…èƒ½æ£€æµ‹ä¸€ç±»æºç‚¹ï¼ˆå¦‚GETè¯·æ±‚ï¼‰ï¼Œå¿½ç•¥POSTè¯·æ±‚ã€å‘½ä»¤è¡Œå‚æ•°ç­‰å…¶ä»–å…¥å£  
- å³ä½¿ä»…å…³æ³¨GETè¯·æ±‚ï¼Œä¸€ä¸ªé¡¹ç›®å¯èƒ½åŒ…å«æ•°åå¤„è°ƒç”¨ï¼Œä½†å…¶ä¸­çœŸæ­£æµå‘æ±‡ç‚¹çš„å±ˆæŒ‡å¯æ•°  
- æ•°æ®åœ¨ç¨‹åºä¸­å¯èƒ½ç»å†å¤æ‚ä¼ æ’­è·¯å¾„ï¼ˆå˜é‡èµ‹å€¼ã€å‡½æ•°ä¼ å‚ç­‰ï¼‰ï¼Œäººå·¥è¿½è¸ªæ•ˆç‡ä½ä¸‹  

åŒç†ï¼Œè‹¥ä»æ±‡ç‚¹ï¼ˆå¦‚`eval()`ï¼‰é€†å‘æº¯æºï¼š  
```python
eval(user_input)                     # å±é™©æ±‡ç‚¹  
```  
éœ€æ’æŸ¥é¡¹ç›®ä¸­æ‰€æœ‰`eval`è°ƒç”¨ï¼Œå¹¶é€æ¡éªŒè¯æ˜¯å¦æ¥æ”¶æœªå‡€åŒ–çš„ç”¨æˆ·è¾“å…¥â€”â€”è¿™å¯¹äºå¤§å‹ä»£ç åº“çŠ¹å¦‚å¤§æµ·æé’ˆã€‚  

**ä¼ ç»Ÿæ­£åˆ™åŒ¹é…çš„å±€é™æ€§**  
- è¯¯æŠ¥ç‡é«˜ï¼šæ— æ³•ç†è§£ä»£ç è¯­ä¹‰ï¼Œä»…ä¾èµ–å…³é”®è¯åŒ¹é…  
- æ‰©å±•æ€§å·®ï¼šæ— æ³•è¿½è¸ªè·¨æ–‡ä»¶/è·¨å‡½æ•°çš„æ•°æ®æµ  
- ç»´æŠ¤æˆæœ¬é«˜ï¼šéœ€ä¸ºä¸åŒæ¡†æ¶/è¯­è¨€å®šåˆ¶æ­£åˆ™è§„åˆ™  

**é™æ€åˆ†æå·¥å…·çš„è¿›åŒ–**  
æ—©æœŸå®‰å…¨å®¡æŸ¥å·¥å…·ï¼ˆå¦‚Fortifyã€Checkmarxï¼‰æ­£æ˜¯ä¸ºè§£å†³è¿™äº›é—®é¢˜è€Œç”Ÿã€‚å®ƒä»¬é€šè¿‡æ„å»º**ä»£ç å±æ€§å›¾ï¼ˆCPGï¼‰**ï¼Œå®ç°ï¼š  
âœ… ç²¾ç¡®è¯†åˆ«æºç‚¹ä¸æ±‡ç‚¹ï¼ˆé¿å…è¯¯æŠ¥ï¼‰  
âœ… è‡ªåŠ¨åŒ–æ•°æ®æµåˆ†æï¼ˆè¿½è¸ªæ±¡æŸ“ä¼ æ’­è·¯å¾„ï¼‰  
âœ… æ”¯æŒå¤šè¯­è¨€/æ¡†æ¶çš„æ¼æ´æ¨¡å¼åº“  


### æ—©æœŸé™æ€åˆ†æå·¥å…·â€”â€”è¯æ³•æ¨¡å¼åŒ¹é…


é™æ€åˆ†æçš„è®¸å¤šæ­¥éª¤ä¸ç¼–è¯‘å™¨å·¥ä½œæµç¨‹å¼‚æ›²åŒå·¥â€”â€”äº‹å®ä¸Šï¼Œç¼–è¯‘å™¨æœ¬èº«å°±åœ¨æ‰§è¡ŒæŸç§é™æ€åˆ†æï¼ˆå¦‚ç±»å‹æ£€æŸ¥ï¼‰ã€‚ç±»å‹æ£€æŸ¥é€šè¿‡éªŒè¯å¯¹è±¡ç±»å‹æ˜¯å¦ç¬¦åˆä¸Šä¸‹æ–‡é¢„æœŸï¼Œèƒ½æœ‰æ•ˆæ¶ˆé™¤æ•´ç±»é”™è¯¯ã€‚è¿™å¯å‘æˆ‘ä»¬å°†ç¼–è¯‘å™¨æŠ€æœ¯ï¼ˆå¦‚è¯æ³•åˆ†æï¼‰å¼•å…¥å®‰å…¨å®¡æŸ¥é¢†åŸŸã€‚  

**ç—›ç‚¹çªç ´ï¼šå™ªå£°è¿‡æ»¤**  
ä¼ ç»Ÿ`grep`å·¥å…·ä¼šè¯¯æŠ“æ³¨é‡Šå’Œå‡½æ•°åä¸­çš„å…³é”®è¯ï¼Œè€Œ**è¯æ³•åˆ†æï¼ˆLexical Analysisï¼‰** å¯è§£å†³æ­¤é—®é¢˜ã€‚è¯¥æŠ€æœ¯å°†æºä»£ç å­—ç¬¦æµè½¬æ¢ä¸º **è¯æ³•å•å…ƒï¼ˆTokenï¼‰** æµï¼Œè‡ªåŠ¨å¿½ç•¥æ— å…³è¯­ä¹‰çš„å­—ç¬¦ï¼ˆå¦‚æ³¨é‡Šã€ç©ºæ ¼ï¼‰ã€‚æ¯ä¸ªTokenåŒ…å«ç±»å‹ã€è¡Œåˆ—ä½ç½®åŠå†…å®¹ä¿¡æ¯ã€‚  

ä»¥å­˜åœ¨SQLæ³¨å…¥æ¼æ´çš„Djangoä»£ç ä¸ºä¾‹ï¼š  
```python
from django.db import connection

def show_user(request, username):
    with connection.cursor() as cursor:
        cursor.execute("SELECT * FROM users WHERE username = '%s'" % username)
```  
`from django.db import connection`ç»è¯æ³•åˆ†æåç”Ÿæˆä»¥ä¸‹Tokenæµï¼ˆä½¿ç”¨Pythonçš„`tokenize`åº“è§£æï¼‰ï¼š  
```lua
# è¡¨ç¤ºæ–‡ä»¶ç¼–ç å£°æ˜ï¼Œç±»å‹63æ˜¯ENCODINGç±»å‹çš„token
# è¿™é‡ŒæŒ‡å®šäº†æ–‡ä»¶ä½¿ç”¨utf-8ç¼–ç 
TokenInfo(type=63 (ENCODING), string='utf-8', start=(0, 0), end=(0, 0), line='')

# ç±»å‹62æ˜¯NLï¼ˆNew Lineï¼‰æ¢è¡Œç¬¦ï¼Œè¡¨ç¤ºç©ºè¡Œ
TokenInfo(type=62 (NL), string='\n', start=(1, 0), end=(1, 1), line='\n')

# å¼€å§‹è§£æç¬¬äºŒè¡Œä»£ç ï¼ˆPythonçš„tokenè¡Œå·ä»0å¼€å§‹ï¼‰
# ç±»å‹1æ˜¯NAMEï¼Œè¡¨ç¤ºæ ‡è¯†ç¬¦/å…³é”®å­—ï¼Œè¿™é‡Œçš„"from"æ˜¯Pythonå¯¼å…¥è¯­æ³•å…³é”®å­—
TokenInfo(type=1 (NAME), string='from', start=(2, 0), end=(2, 4), line='from django.db import connection\n')

# "django"æ˜¯å¯¼å…¥çš„åŒ…å
TokenInfo(type=1 (NAME), string='django', start=(2, 5), end=(2, 11), line='from django.db import connection\n')

# ç±»å‹54æ˜¯æ“ä½œç¬¦ï¼ˆOPï¼‰ï¼Œè¿™é‡Œçš„ç‚¹å·è¡¨ç¤ºåŒ…å±‚çº§åˆ†éš”ç¬¦
TokenInfo(type=54 (OP), string='.', start=(2, 11), end=(2, 12), line='from django.db import connection\n')

# "db"æ˜¯djangoåŒ…çš„å­æ¨¡å—
TokenInfo(type=1 (NAME), string='db', start=(2, 12), end=(2, 14), line='from django.db import connection\n')

# "import"æ˜¯å¯¼å…¥å…³é”®å­—
TokenInfo(type=1 (NAME), string='import', start=(2, 15), end=(2, 21), line='from django.db import connection\n')

# "connection"æ˜¯è¦å¯¼å…¥çš„å…·ä½“å¯¹è±¡
TokenInfo(type=1 (NAME), string='connection', start=(2, 22), end=(2, 32), line='from django.db import connection\n')

# ç±»å‹4æ˜¯NEWLINEï¼Œè¡¨ç¤ºè¯­å¥ç»“æŸçš„æ¢è¡Œç¬¦
TokenInfo(type=4 (NEWLINE), string='\n', start=(2, 32), end=(2, 33), line='from django.db import connection')  
```  

**çŸ¥è¯†åº“é©±åŠ¨çš„æ¼æ´æ£€æµ‹**  
æ—©æœŸå·¥å…·ï¼ˆå¦‚ITS4ã€Flawfinderã€RATSï¼‰å¼•å…¥**æ¼æ´çŸ¥è¯†åº“**ï¼Œå…¶ä¸­é¢„å®šä¹‰å±é™©å‡½æ•°ï¼ˆæ±‡ç‚¹ï¼‰ç‰¹å¾ã€‚å½“TokenæµåŒ¹é…åˆ°çŸ¥è¯†åº“ä¸­çš„æ±‡ç‚¹æ¨¡å¼æ—¶ï¼Œå·¥å…·ä¼šæ ‡è®°æ½œåœ¨é£é™©ã€‚ä¾‹å¦‚æ£€æµ‹åˆ°`cursor.execute()`è°ƒç”¨æ—¶è§¦å‘å‘Šè­¦ï¼Œå¹¶æç¤ºSQLæ³¨å…¥é£é™©ã€‚  

**é˜¶æ®µæ€§æˆæœä¸é—ç•™é—®é¢˜**  
âœ… é€šè¿‡è¯æ³•åˆ†ææ¶ˆé™¤æ³¨é‡Š/å‡½æ•°åè¯¯æŠ¥  
âœ… åŸºäºçŸ¥è¯†åº“å®ç°æºç‚¹/æ±‡ç‚¹çš„è‡ªåŠ¨åŒ–è¯†åˆ«  
âš ï¸ ä½†å·¥å…·ä»ä¼šæŠ¥å‘Šå¤§é‡**æ— å®³æ±‡ç‚¹è°ƒç”¨**ï¼ˆå¦‚å·²å‡€åŒ–çš„ç”¨æˆ·è¾“å…¥ï¼‰  

**å…³é”®æŒ‘æˆ˜ï¼šå»ºç«‹æºæ±‡å…³è”**  
çœŸæ­£çš„æ¼æ´éœ€å­˜åœ¨**ä»æºç‚¹åˆ°æ±‡ç‚¹çš„æ•°æ®æµè·¯å¾„**ã€‚å¦‚ä½•è‡ªåŠ¨åŒ–éªŒè¯è¿™ç§å…³è”ï¼Ÿè¿™å¼•å‡ºäº†é™æ€åˆ†æçš„æ ¸å¿ƒè¯¾é¢˜â€”â€”  
> **æ•°æ®æµåˆ†æï¼ˆData Flow Analysisï¼‰**  
> é€šè¿‡è¿½è¸ªå˜é‡èµ‹å€¼ã€å‡½æ•°ä¼ å‚ç­‰è·¯å¾„ï¼Œæ„å»ºç¨‹åºä¸­æ•°æ®çš„æµåŠ¨è½¨è¿¹ï¼Œåˆ¤æ–­æ±¡æŸ“æ•°æ®æ˜¯å¦æŠµè¾¾å±é™©å‡½æ•°ã€‚  
- è¯æ³•åˆ†æ â†’ è¯­æ³•åˆ†æ â†’ æ§åˆ¶æµ/æ•°æ®æµåˆ†æ â†’ ä¸Šä¸‹æ–‡æ•æ„Ÿåˆ†æ

### è¯­æ³•æ¨¡å¼åŒ¹é…ã€æŠ½è±¡è¯­æ³•æ ‘ä¸æ§åˆ¶æµå›¾


æœ€æ—©çš„é™æ€åˆ†æå·¥å…·ä»…åˆ©ç”¨ç¼–è¯‘å™¨ç†è®ºä¸­çš„ä¸€é¡¹æŠ€æœ¯â€”â€”è¯æ³•åˆ†æã€‚æé«˜æ¼æ´æ£€æµ‹ç²¾åº¦çš„å…³é”®æ–¹æ³•ä¹‹ä¸€æ˜¯é€šè¿‡å¼•å…¥æ›´å¤šç¼–è¯‘å™¨ç†è®ºä¸­çš„æŠ€æœ¯ã€‚éšç€æ—¶é—´æ¨ç§»ï¼Œé™æ€åˆ†æå·¥å…·é€æ­¥é‡‡ç”¨äº†ç¼–è¯‘å™¨é¢†åŸŸçš„æ›´å¤šæŠ€æœ¯ï¼Œä¾‹å¦‚è¯­æ³•è§£æï¼ˆparsingï¼‰å’ŒæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ã€‚å°½ç®¡å­˜åœ¨å¤šç§é™æ€åˆ†ææ–¹æ³•ï¼Œæˆ‘ä»¬å°†é‡ç‚¹æ¢è®¨æœ€æµè¡Œçš„æŠ€æœ¯ä¹‹ä¸€â€”â€”ç»“åˆæ±¡ç‚¹åˆ†æï¼ˆtaint analysisï¼‰çš„æ•°æ®æµåˆ†æï¼ˆdata flow analysisï¼‰ã€‚

---

#### ä»tokenåˆ°AST
åœ¨å®Œæˆä»£ç çš„ä»¤ç‰Œï¼ˆtokenï¼‰æ‰«æåï¼Œå¯ä»¥å°†å…¶è½¬æ¢ä¸ºæ›´æŠ½è±¡çš„è¡¨ç¤ºå½¢å¼ï¼Œä»¥ä¾¿æ›´é«˜æ•ˆåœ°æŸ¥è¯¢ä»£ç ç»“æ„ã€‚å¸¸è§æ–¹æ³•ä¹‹ä¸€æ˜¯å°†ä»£ç è§£æä¸ºè§£ææ ‘ï¼ˆparse treeï¼‰å¹¶æ„å»ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰â€”â€”æˆ‘ä»¬æ›´å…³æ³¨åè€…ã€‚æŠ½è±¡è¯­æ³•æ ‘æ˜¯æºä»£ç çš„æ ‘å½¢è¡¨ç¤ºå½¢å¼ï¼Œå®ƒä½¿æˆ‘ä»¬èƒ½å¤Ÿä»å¤„ç†ä»¤ç‰Œæµè½¬å‘å¤„ç†å…·æœ‰è¯­ä¹‰ç»“æ„çš„ä»£ç è¡¨ç¤ºã€‚ASTä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å…¶ç±»å‹ï¼Œè¿™äº›ç±»å‹åæ˜ äº†ä»£ç çš„"è¯­ä¹‰"ï¼ˆå³ä»£ç çš„"å«ä¹‰"ï¼‰ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæ–¹æ³•è°ƒç”¨ä¼šè¢«è¡¨ç¤ºä¸ºæ ‘ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå…¶é™å®šç¬¦ï¼ˆqualifierï¼‰å’Œå‚æ•°åˆ™ä½œä¸ºå­èŠ‚ç‚¹å­˜åœ¨ã€‚é€šè¿‡æŠ½è±¡è¯­æ³•æ ‘ï¼Œæˆ‘ä»¬å¯ä»¥æ›´ä¾¿æ·åœ°åœ¨åˆ†æä¸­å®šä½ç›®æ ‡ä»£ç ã€‚åœ¨æ­¤é˜¶æ®µï¼Œåˆ©ç”¨ASTå¯ä»¥é«˜ç²¾åº¦æ£€æµ‹æŸäº›ç®€å•æ¼æ´ï¼Œä¾‹å¦‚ç¦ç”¨äº†CSRFä¿æŠ¤æˆ–åº”ç”¨ç¨‹åºåœ¨è°ƒè¯•æ¨¡å¼ä¸‹è¿è¡Œã€‚

---

##### å¯è§†åŒ–ç¤ºä¾‹ï¼šPythonä»£ç çš„ASTè¡¨ç¤º
ä¸ºç›´è§‚å±•ç¤ºï¼Œæˆ‘ä»¬ä»¥å­˜åœ¨SQLæ³¨å…¥æ¼æ´çš„Pythonç¨‹åºä¸ºä¾‹ï¼Œå±•ç¤ºå…¶ASTã€‚é€šè¿‡Pythonçš„`ast`å’Œ`astpretty`æ¨¡å—ï¼Œå¯å°†ä»£ç è§£æä¸ºæŠ½è±¡è¯­æ³•æ ‘ã€‚ä»¥ä¸‹æ˜¯ç¨‹åºçš„éƒ¨åˆ†ASTï¼š

```python
```less
Module(
    body=[
        ImportFrom(
            lineno=2,
            col_offset=0,
            end_lineno=2,
            end_col_offset=32,
            module='django.db',
            names=[alias(lineno=2, col_offset=22, end_lineno=2, end_col_offset=32, name='connection', asname=None)],
            level=0,
        ),
        FunctionDef(
            lineno=5,
            col_offset=0,
            end_lineno=7,
            end_col_offset=78,
            name='show_user',
            args=arguments(
                posonlyargs=[],
                args=[
                    arg(lineno=5, col_offset=14, end_lineno=5, end_col_offset=21, arg='request', annotation=None, type_comment=None),
                    arg(lineno=5, col_offset=23, end_lineno=5, end_col_offset=31, arg='username', annotation=None, type_comment=None),
                ],
                vararg=None,
                kwonlyargs=[],
                kw_defaults=[],
                kwarg=None,
                defaults=[],
            ),
            body=[
                With(
                    lineno=6,
                    col_offset=4,
                    end_lineno=7,
                    end_col_offset=78,
                    items=[
                        withitem(
                            context_expr=Call(
                                lineno=6,
                                col_offset=9,
                                end_lineno=6,
                                end_col_offset=28,
                                func=Attribute(
                                    lineno=6,
                                    col_offset=9,
                                    end_lineno=6,
                                    end_col_offset=26,
                                    value=Name(lineno=6, col_offset=9, end_lineno=6, end_col_offset=19, id='connection', ctx=Load()),
                                    attr='cursor',
                                    ctx=Load(),
                                ),
                                args=[],
                                keywords=[],
                            ),
                            optional_vars=Name(lineno=6, col_offset=32, end_lineno=6, end_col_offset=38, id='cursor', ctx=Store()),
                        ),
                    ],
                    body=[
                        Expr(
                            lineno=7,
                            col_offset=8,
                            end_lineno=7,
                            end_col_offset=78,
                            value=Call(
                                lineno=7,
                                col_offset=8,
                                end_lineno=7,
                                end_col_offset=78,
                                func=Attribute(
                                    lineno=7,
                                    col_offset=8,
                                    end_lineno=7,
                                    end_col_offset=22,
                                    value=Name(lineno=7, col_offset=8, end_lineno=7, end_col_offset=14, id='cursor', ctx=Load()),
                                    attr='execute',
                                    ctx=Load(),
                                ),
                                args=[
                                    BinOp(
                                        lineno=7,
                                        col_offset=23,
                                        end_lineno=7,
                                        end_col_offset=77,
                                        left=Constant(lineno=7, col_offset=23, end_lineno=7, end_col_offset=66, value="SELECT * FROM users WHERE username = '%s'", kind=None),
                                        op=Mod(),
                                        right=Name(lineno=7, col_offset=69, end_lineno=7, end_col_offset=77, id='username', ctx=Load()),
                                    ),
                                ],
                                keywords=[],
                            ),
                        ),
                    ],
                    type_comment=None,
                ),
            ],
            decorator_list=[],
            returns=None,
            type_comment=None,
        ),
    ],
    type_ignores=[],
)
```


---

##### ASTçš„å¯è§†åŒ–ä¸ä»£ç å¯¹ç…§
é€šè¿‡Pythonçš„`ast`æ¨¡å—è§£æä»£ç ï¼Œå¹¶ä½¿ç”¨`graphviz`åº“ç”Ÿæˆç®€åŒ–çš„ASTå›¾å½¢è¡¨ç¤ºï¼ˆä¸ºæé«˜å¯è¯»æ€§ï¼Œå›¾ä¸­çœç•¥äº†éƒ¨åˆ†ç»†èŠ‚ï¼‰ã€‚ä»¥ä¸‹æ˜¯åŸå§‹ä»£ç ä¸ASTçš„å¯¹ç…§ï¼š

**ä»£ç ç‰‡æ®µ**ï¼š
```python
1. from django.db import connection  # å¯¼å…¥æ•°æ®åº“è¿æ¥æ¨¡å—
2.
2. def show_user(request, username):  # å®šä¹‰è§†å›¾å‡½æ•°
3.     with connection.cursor() as cursor:  # è·å–æ•°æ®åº“æ¸¸æ ‡
4.         cursor.execute("SELECT * FROM users WHERE username = '%s'" % username)  # å­˜åœ¨SQLæ³¨å…¥é£é™©çš„æŸ¥è¯¢
```
![](media/codeql1.webp)  
**ASTå…³é”®èŠ‚ç‚¹**ï¼š
- `Module`ï¼šä»£ç æ¨¡å—æ ¹èŠ‚ç‚¹
  - `ImportFrom`ï¼šå¯¹åº”ç¬¬1è¡Œçš„`from ... import`è¯­å¥
  - `FunctionDef`ï¼šç¬¬3è¡Œçš„å‡½æ•°å®šä¹‰
    - `args`ï¼šå‡½æ•°å‚æ•°åˆ—è¡¨ï¼ˆ`request`, `username`ï¼‰
    - `With`ï¼šç¬¬4è¡Œçš„`with`ä¸Šä¸‹æ–‡å—
      - `Call`ï¼š`connection.cursor()`æ–¹æ³•è°ƒç”¨
      - `Assign`ï¼šå°†æ¸¸æ ‡èµ‹å€¼ç»™`cursor`
    - `Expr`ï¼šç¬¬5è¡Œçš„è¡¨è¾¾å¼
      - `Call`ï¼š`cursor.execute()`æ–¹æ³•è°ƒç”¨
        - `BinOp`ï¼šå­—ç¬¦ä¸²æ ¼å¼åŒ–æ“ä½œï¼ˆ`%`ï¼‰ï¼Œæ­¤å¤„å¯¼è‡´SQLæ³¨å…¥æ¼æ´
---

##### æ–¹æ³•è°ƒç”¨èŠ‚ç‚¹ä¸ASTçš„æŸ¥è¯¢èƒ½åŠ›
æ­£å¦‚å‰æ–‡æ‰€è¿°ï¼ŒASTä¸­çš„æ–¹æ³•è°ƒç”¨ä¼šè¢«è¡¨ç¤ºä¸ºç‰¹å®šç±»å‹èŠ‚ç‚¹ã€‚é€šè¿‡å¯è§†åŒ–ï¼ˆå¦‚ä¸Šå›¾ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ç¬¬5è¡Œçš„`Call`èŠ‚ç‚¹ï¼ˆå¯¹åº”æ–¹æ³•è°ƒç”¨ï¼‰ï¼Œå…¶é™å®šç¬¦ï¼ˆå¦‚`cursor`ï¼‰å’Œå‚æ•°ï¼ˆå¦‚SQLè¯­å¥ï¼‰å‡ä»¥å­èŠ‚ç‚¹å½¢å¼å‘ˆç°ã€‚

**åŸºäºASTçš„ä»£ç æŸ¥è¯¢ç¤ºä¾‹**ï¼š  
1. **å®šä½ç‰¹å®šæ–¹æ³•è°ƒç”¨**ï¼šæœç´¢`django.db`åº“ä¸­æ‰€æœ‰çš„`execute`æ–¹æ³•è°ƒç”¨èŠ‚ç‚¹  
   ```python
   # ASTæŸ¥è¯¢ä¼ªä»£ç ç¤ºä¾‹
   find_nodes(type=Call, qualifier="django.db.execute")
   ```
   â†’ ä»…è¿”å›ç›®æ ‡æ–¹æ³•è°ƒç”¨ï¼Œè¿‡æ»¤å…¶ä»–æ— å…³èŠ‚ç‚¹ç±»å‹  

2. **è¯†åˆ«å±é™©è°ƒç”¨æ¨¡å¼**ï¼šç­›é€‰å‚æ•°éå­—ç¬¦ä¸²å­—é¢é‡ï¼ˆstring literalï¼‰çš„`execute`è°ƒç”¨  
   ```python
   # æ·»åŠ å‚æ•°ç±»å‹è¿‡æ»¤æ¡ä»¶
   filter(call_node => call_node.arguments[0].type != "Str")
   ```
   â†’ æ’é™¤å®‰å…¨è°ƒç”¨ï¼ˆå¦‚`cursor.execute("SELECT * FROM safe_table")`ï¼‰  
   â†’ æ•è·é«˜é£é™©è°ƒç”¨ï¼ˆå¦‚ç¤ºä¾‹ä¸­`"SELECT ... %s" % username`çš„åŠ¨æ€æ‹¼æ¥ï¼‰  


#### æ§åˆ¶æµå›¾ï¼ˆCFGï¼‰å¢å¼ºåˆ†æç²¾åº¦
ä¸ºè¿›ä¸€æ­¥æå‡åˆ†æå‡†ç¡®æ€§ï¼Œéœ€ç»“åˆ**æ§åˆ¶æµå›¾**ï¼ˆControl Flow Graph, CFGï¼‰ã€‚CFGæè¿°ç¨‹åºæ‰€æœ‰å¯èƒ½æ‰§è¡Œè·¯å¾„ä¸­åŸºæœ¬è¯­å¥ï¼ˆprimitive statementsï¼‰çš„æ‰§è¡Œé¡ºåºï¼š  
- **èŠ‚ç‚¹**ï¼šå¯¹åº”ä»£ç ä¸­çš„åŸºæœ¬è¯­å¥ï¼ˆå¦‚èµ‹å€¼ã€æ¡ä»¶åˆ¤æ–­ï¼‰  
- **è¾¹**ï¼šè¡¨ç¤ºè¯­å¥é—´çš„æ‰§è¡Œé¡ºåºå¯èƒ½æ€§  

ä»¥ä¸‹åˆ—å­˜åœ¨æ¡ä»¶åˆ†æ”¯çš„SQLæ³¨å…¥ä»£ç ä¸ºä¾‹ï¼š  
```python
1. username = request.GET.get("username")  # è·å–ç”¨æˆ·è¾“å…¥
2. if request.user.is_superuser:           # ç®¡ç†å‘˜åˆ†æ”¯
3.    sql = "SELECT * FROM users"          # é™æ€å®‰å…¨æŸ¥è¯¢
4.    cursor.execute(sql)                  
5. elif request.user.is_authenticated:     # è®¤è¯ç”¨æˆ·åˆ†æ”¯
6.    sql = f"SELECT * FROM users WHERE username={username}"  # åŠ¨æ€æ‹¼æ¥ï¼ˆé«˜å±ï¼ï¼‰
7.    cursor.execute(sql)                  
8. else:                                   # æœªè®¤è¯åˆ†æ”¯
9.    print("404")                        
```
![](media/codeql3.webp)

---

#####  æŠ€æœ¯ä»·å€¼è§£æ
1. **CFGçš„æ¼æ´å®šä½ä¼˜åŠ¿**  
   - æ˜ç¡®æ¼æ´è§¦å‘æ¡ä»¶ï¼šç¤ºä¾‹ä¸­**ä»…å½“ç”¨æˆ·é€šè¿‡è®¤è¯ä½†éç®¡ç†å‘˜æ—¶**ï¼ˆç¬¬5-7è¡Œï¼‰ï¼ŒåŠ¨æ€SQLæ‹¼æ¥æ‰ä¼šè¢«æ‰§è¡Œ  
   - è¯†åˆ«è·¨æ¡ä»¶æ•°æ®æµï¼šè·Ÿè¸ª`username`ä»ç¬¬1è¡Œè¾“å…¥åˆ°ç¬¬6è¡ŒæŸ¥è¯¢çš„å®Œæ•´ä¼ æ’­è·¯å¾„  

2. **ASTä¸CFGçš„ååŒåˆ†æ**  
   ```mermaid
   graph LR
   A[è¯æ³•åˆ†æ] --> B[ç”ŸæˆAST]
   B --> C[è¯†åˆ«executeè°ƒç”¨]
   C --> D[æ„å»ºCFG]
   D --> E{åŠ¨æ€å‚æ•°æµå…¥execute?}
   E -->|æ˜¯| F[æ ‡è®°ä¸ºæ½œåœ¨æ¼æ´]
   E -->|å¦| G[æ’é™¤è¯¯æŠ¥]
   ```
   é€šè¿‡ASTå®šä½æ•æ„Ÿæ–¹æ³•è°ƒç”¨ï¼Œç»“åˆCFGéªŒè¯æ•°æ®æµå¯è¡Œæ€§ï¼Œå®ç°**é«˜ç²¾åº¦æ¼æ´æ£€æµ‹**ã€‚  

---

### æ•°æ®æµåˆ†æä¸æ±¡ç‚¹è¿½è¸ª

#### æ•°æ®æµåˆ†æçš„åŸç†ä¸å±€é™
é€šè¿‡æ§åˆ¶æµå›¾ï¼ˆCFGï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥éªŒè¯ç‰¹å®š**æ•°æ®æº**ï¼ˆsourceï¼‰ä¸**å±é™©å‡½æ•°è°ƒç”¨ç‚¹**ï¼ˆsinkï¼‰ä¹‹é—´æ˜¯å¦å­˜åœ¨æ•°æ®æµè¿æ¥ï¼Œè¿™ç§æŠ€æœ¯ç§°ä¸º**æ•°æ®æµåˆ†æ**ã€‚è¯¥æŠ€æœ¯ç»“åˆæ§åˆ¶æµå›¾ã€è°ƒç”¨å›¾ï¼ˆCall Graphï¼‰å’Œé™æ€å•èµ‹å€¼å½¢å¼ï¼ˆSSAï¼‰æ¥æ¨¡æ‹Ÿæ•°æ®åœ¨ä»£ç ä¸­çš„ä¼ æ’­è·¯å¾„ã€‚ä½†å…¶æ ¸å¿ƒé™åˆ¶åœ¨äºï¼šä»…è¿½è¸ª**å€¼ä¿æŒä¸å˜çš„æ•°æ®**ã€‚ä¾‹å¦‚ï¼Œå½“å­—ç¬¦ä¸²ç»è¿‡æ‹¼æ¥æ“ä½œï¼ˆå¦‚`str1 + str2`ï¼‰ç”Ÿæˆæ–°å€¼æ—¶ï¼Œæ•°æ®æµåˆ†æå°†ä¸¢å¤±åŸå˜é‡çš„è¿½è¸ªè·¯å¾„â€”â€”è¿™æ­£æ˜¯å‰æ–‡ç¤ºä¾‹ä¸­åŠ¨æ€SQLæ‹¼æ¥åœºæ™¯çš„å…¸å‹é—®é¢˜ã€‚

#### æ±¡ç‚¹è¿½è¸ªçš„æŠ€æœ¯çªç ´
æ±¡ç‚¹è¿½è¸ªï¼ˆtaint trackingï¼‰é‡‡ç”¨å·®å¼‚åŒ–è§„åˆ™è§£å†³ä¸Šè¿°é—®é¢˜ï¼š
1. **æ±¡æŸ“æ ‡è®°**ï¼šå°†ç”¨æˆ·å¯æ§çš„è¾“å…¥ï¼ˆå¦‚`request.GET.get("username")`ï¼‰æ ‡è®°ä¸º"å—æ±¡æŸ“"ï¼ˆtaintedï¼‰
2. **ä¼ æ’­è§„åˆ™**ï¼šå³ä½¿æ•°æ®ç»è¿‡è½¬æ¢ï¼ˆå¦‚å­—ç¬¦ä¸²æ’å€¼ã€å¯¹è±¡å±æ€§èµ‹å€¼ï¼‰ï¼Œæ±¡æŸ“çŠ¶æ€ä»æŒç»­ä¼ é€’
3. **ç»ˆç»“ç‚¹æ£€æµ‹**ï¼šå½“æ±¡æŸ“æ•°æ®æµå…¥å±é™©å‡½æ•°ï¼ˆå¦‚`cursor.execute()`ï¼‰æ—¶è§¦å‘å‘Šè­¦
![](media/dataflowpath.webp)  
**ä»£ç ç¤ºä¾‹**ï¼š
```python
1. from django.db import connection
2.
2. def profile(request):
3.    with connection.cursor() as cursor:
4.        username = request.GET.get("username")  # æ±¡æŸ“æº
5.        sql = f"SELECT * FROM users WHERE username={username}"  # æ±¡æŸ“ä¼ æ’­
6.        cursor.execute(sql)  # æ±¡æŸ“ç»ˆç»“ç‚¹
```
![](media/codeql4.webp)  
**åˆ†æè¿‡ç¨‹å¯¹æ¯”**ï¼š
| åˆ†æç±»å‹        | è¿½è¸ªèƒ½åŠ›                        | ç¤ºä¾‹ç»“æœåˆ¤æ–­               |
|-----------------|--------------------------------|---------------------------|
| æ•°æ®æµåˆ†æ      | ä¸¢å¤±å˜é‡`username`åˆ°å˜é‡`sql`çš„å…³è”    | æ¼æŠ¥SQLæ³¨å…¥               | 
| æ±¡ç‚¹è¿½è¸ª        | ä¿æŒ`usernameâ†’sql`çš„æ±¡æŸ“é“¾     | å‡†ç¡®å‘Šè­¦                  |

#### è¯¯æŠ¥æ§åˆ¶ä¸å‡€åŒ–æœºåˆ¶
é™æ€åˆ†æå·¥å…·é€šè¿‡**å‡€åŒ–å‡½æ•°è¯†åˆ«**é™ä½è¯¯æŠ¥ï¼š
1. **å†…ç½®å‡€åŒ–åº“**ï¼šè‡ªåŠ¨è¯†åˆ«æ ‡å‡†å®‰å…¨å‡½æ•°ï¼ˆå¦‚`MySQLdb.escape_string()`ï¼‰
2. **ä¼ æ’­é˜»æ–­**ï¼šå½“æ±¡æŸ“æ•°æ®æµç»å‡€åŒ–å‡½æ•°æ—¶ç»ˆæ­¢è¿½è¸ªé“¾
3. **è‡ªå®šä¹‰æ‰©å±•**ï¼šæ”¯æŒç”¨æˆ·å®šä¹‰é¡¹ç›®ç‰¹æœ‰å‡€åŒ–æ–¹æ³•

**è¯¯æŠ¥å¤„ç†åœºæ™¯**ï¼š
```python
# å®‰å…¨åœºæ™¯ï¼šæ±¡æŸ“æ•°æ®è¢«å‡€åŒ–
safe_username = sanitize(username)  # è‡ªå®šä¹‰å‡€åŒ–å‡½æ•°
cursor.execute(f"SELECT * FROM users WHERE username={safe_username}")  # ä¸è§¦å‘å‘Šè­¦
```

#### å…¶ä»–å†…éƒ¨è¡¨ç¤ºå½¢å¼
| è¡¨ç¤ºå½¢å¼            | æ ¸å¿ƒä½œç”¨        | åº”ç”¨åœºæ™¯      |
| --------------- | ----------- | --------- |
| è°ƒç”¨å›¾ï¼ˆCall Graphï¼‰ | æè¿°å‡½æ•°é—´è°ƒç”¨å…³ç³»   | è·¨å‡½æ•°æ•°æ®æµåˆ†æ  |
| SSAå½¢å¼           | ç¡®ä¿æ¯ä¸ªå˜é‡ä»…èµ‹å€¼ä¸€æ¬¡ | æå‡æ•°æ®æµåˆ†æç²¾åº¦ |

#### é™æ€åˆ†æå·¥å…·æ¶æ„å…¨æ™¯
å…¸å‹é™æ€åˆ†æå·¥å…·çš„ä¸‰å±‚æ¶æ„ï¼š
1. **è§£æå±‚**ï¼šå°†æºç è½¬æ¢ä¸ºAST/CFGç­‰ä¸­é—´è¡¨ç¤º
2. **è¡¨ç¤ºå±‚**ï¼šæ„å»ºå¤šç§ä»£ç æ¨¡å‹ï¼ˆAST/CFG/SSA/è°ƒç”¨å›¾ï¼‰
3. **åˆ†æå±‚**ï¼šåŸºäºæ¨¡å‹æ‰§è¡Œæ•°æ®æµ/æ±¡ç‚¹è¿½è¸ªç­‰ç®—æ³•

#### æŠ€æœ¯æ¼”è¿›è·¯çº¿
```mermaid
graph LR
    A[è¯æ³•åˆ†æ] --> B[è¯­æ³•åˆ†æç”ŸæˆAST]
    B --> C[æ„å»ºCFG/SSA]
    C --> D[åŸºç¡€æ•°æ®æµåˆ†æ]
    D --> E[æ±¡ç‚¹è¿½è¸ªå¢å¼º]
    E --> F[è·¨è¿‡ç¨‹è°ƒç”¨å›¾åˆ†æ]
    F --> G[ä¸Šä¸‹æ–‡æ•æ„Ÿåˆ†æ]
```



## Todo
- [ ] å†™ä¸€ä¸ªç®€å•çš„é™æ€åˆ†æå·¥å…·
- [ ] åœ¨ä¸åŒçš„è„†å¼±æ€§ä¸­æ‰¾åˆ°æ½œåœ¨çš„æºå’Œæ±‡
	- [ ] https://codeql.github.com/codeql-query-help/python/
- [ ] åˆ†ææœ€æ–°çš„æ³¨å…¥æ¼æ´ä¹‹ä¸€
	- [ ] [Cve-2025-3248](obsidian://open?vault=Noah-s_Ark&file=%E5%85%A8%E6%A0%88%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%2FPython%2FCve%E7%A0%94%E7%A9%B6%2FCVE-2025-3248)

## link
- https://ieeexplore.ieee.org/document/4221615?arnumber=4221615

