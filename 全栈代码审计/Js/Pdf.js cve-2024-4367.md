- https://codeanlabs.com/blog/research/cve-2024-4367-arbitrary-js-execution-in-pdf-js/
## 创建环境

### Pdf.js 漏洞版本
```bash
git clone https://github.com/mozilla/pdf.js.git
cd pdf.js
git checkout v4.1.392
```

### Codeql创建数据库
````bash
codeql database create database/pdfjs-database --language=javascript --source-root=source/pdf.js
````


## 分析


## Codeql复现

### Sink寻找

#### 分析
```javascript
// 检查是否支持eval函数（动态执行代码的能力）
if (this.isEvalSupported && FeatureTest.isEvalSupported) {
  // 创建一个数组来保存生成的JavaScript代码
  const jsBuf = [];
  // 遍历所有绘图命令
  for (const current of cmds) {
    // 将参数转换为逗号分隔的字符串
    const args = current.args !== undefined ? current.args.join(",") : "";
    // 将命令和参数拼接成函数调用形式
    jsBuf.push("c.", current.cmd, "(", args, ");\n");
  }
  // 输出生成的代码（用于调试）
  console.log(jsBuf.join(""));
  // 使用new Function创建新函数
  return (this.compiledGlyphs[character] = new Function(
    "c",
    "size",
    jsBuf.join("")
  ));
} 
```

#### Sink
```javascript
import javascript

from NewExpr newCall
where newCall.getCalleeName() = "Function"
select newCall, "Found new Function() call"
```

![](media/Pasted%20image%2020250828161630.png)  


### Source
```javascript
import javascript

from CallExpr call, StringLiteral str
where
  call.getCalleeName() = "getArray" and
  str.getValue() = "FontMatrix" and
  call.getArgument(0) = str
select call, "Found FontMatrix access"
```

![](media/Pasted%20image%2020250828162013.png)  



### 数据流
