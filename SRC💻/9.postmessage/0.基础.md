
### ​JavaScript 跨窗口通信
1. 同源策略（SOP）下的直接调用​​
```html
<!DOCTYPE html>
<html>
    <head>
        <script>
            let btn = function(){
            // 直接调用 iframe 中的函数（仅限同源）
                document.getElementById('frame').contentWindow.hello('Hello IFRAME');
            }
        </script>
    </head>
    <body>
    <iframe src="/one_target" id="frame"></iframe>
    <button onclick="btn()">RUN</button>
    </body>
</html>
```
- IFRAME: /one_target
```html
<!DOCTYPE html>
<html>
<head>
    <script>

        function hello(str){
            alert(str);
        }

    </script>
</head>
<body>
    IFRAME PAGE
</body>
</html>
```
3. Onlick结果​：调用成功，因为主页面和 iframe 同源（协议、域名、端口相同）。✅
![](media/Pasted%20image%2020250827104207.png)  
### **跨源（Cross-Origin）直接调用的限制​​
```html
<!DOCTYPE html>
<html>
    <head>
        <script>
            let btn = function(){
            
            // 尝试调用跨源 iframe 的函数
                document.getElementById('frame').contentWindow.hello('HELLO IFRAME');
            }
        </script>
    </head>
    <body>
    <iframe src="https://pm.nahamseclab.com/two_target" id="frame"></iframe>
    <button onclick="btn()">RUN</button>
    </body>
</html>
```
- iframe：https://pm.nahamseclab.com/two_target
```html
<!DOCTYPE html>
<html>
<head>
    <script>

        function hello(str){
            alert(str);
        }

    </script>
</head>
<body>
IFRAME PAGE
</body>
</html>
```
- onclick后：同源策略阻止了跨域访问 iframe 的内部属性和方法。❌
```js
SES_UNCAUGHT_EXCEPTION: DOMException: Permission denied to access property "hello" on cross-origin object
    btn https://6b1rluvn.eu1.ctfio.com/two/ line 7 > inlineScript:6
    onclick https://6b1rluvn.eu1.ctfio.com/two/:1
lockdown-install.js:1:145467
    <anonymous> moz-extension://70930c6d-de31-4777-8a2b-b0db7272fa7b/scripts/lockdown-install.js:1
```

### PostMessage
- 使用 `postMessage`发送消息，iframe 通过事件监听接收。
```html
<!DOCTYPE html>
<html>
    <head>
        <script>
            let btn = function(){
                msg = {
                    'msg'   :   'Hello IFRAME'
                }
                // 向 iframe 发送消息（使用 '*' 目标 origin，慎用！）
                document.getElementById('frame').contentWindow.postMessage(msg,'*');
            }
        </script>
    </head>
    <body>
    <iframe src="https://pm.nahamseclab.com/three_target" id="frame"></iframe>
    <button onclick="btn()">RUN</button>
    </body>
</html>
```
- iframe：
```html
<!DOCTYPE html>
<html>
<head>
    <script>
        window.addEventListener("message",function(event){
			// if (event.origin !== "https://expected-domain.com") return;
            if( event.data.hasOwnProperty('msg') ) {

                alert(event.data.msg);

            }
        });
    </script>
</head>
<body>
IFRAME PAGE
</body>
</html>
```
- 结果：跨域通信成功，通过事件监听机制安全接收数据。




###  安全注意事项
1. 验证event.origin
```js
window.addEventListener("message", function(event){
    // 只接受来自可信源的消息
    if (event.origin !== "https://trusted-source.com") return;
    // 处理消息...
});
```
**漏洞​**​：不验证 origin 可能导致恶意网站发送恶意消息。
2. 避免使用通配符 `'*'`​​
- **错误示例​**​：`postMessage(msg, '*')`
    - 允许任何来源的页面接收消息，包括恶意网站。
- ​**​正确做法​**​：指定目标 origin：
    `postMessage(msg, "https://target-domain.com")`  
3. 