- https://updraft.cyfrin.io/courses/security
- https://github.com/Cyfrin/security-and-auditing-full-course-s23

## ToolsğŸ”¨
- vscode
- wsl ï¼ˆlinuxç¯å¢ƒï¼‰
- Foundry
	- Foundry æ˜¯ä¸€ä¸ªç”¨äºä»¥å¤ªåŠæ™ºèƒ½åˆçº¦çš„å¼€å‘å·¥å…·åŒ…ï¼Œç‰¹åˆ«é€‚åˆç”¨ Solidity ç¼–å†™çš„åˆçº¦ã€‚
	- https://book.getfoundry.sh/getting-started/installation
	- `cast` / `chisel`

## Solidity Prerequisites ğŸ–Š
### Solidty
- [solidtyåŸºç¡€](../0.åŸºç¡€çŸ¥è¯†/1.Solidity)

### Foundry

1. `forge init`  //åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„é¡¹ç›®                                                                                                                                                                                   ![](media/solidity-prerequisites1.png)
2. åŸºç¡€å‘½ä»¤
	1. åˆ›å»ºé¡¹ç›® `mkdir basic-solc-project  && cd basic-solc-project`
	2. `forge init  //åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„é¡¹ç›®`![](media/Pasted%20image%2020250122164233.png)
	3. `forge build //ç¼–è¯‘é¡¹ç›®æ™ºèƒ½åˆçº¦`![](media/Pasted%20image%2020250122164431.png)  4. `forge test //æŸ¥æ‰¾æµ‹è¯•æ–‡ä»¶ï¼Œç¼–è¯‘æµ‹è¯•åˆçº¦ï¼Œè¿è¡Œæµ‹è¯•ï¼ŒæŠ¥å‘Šç»“æœ`![](media/Pasted%20image%2020250122164458.png) 
3. ç†Ÿæ‚‰Foundryçš„åŸºæœ¬ä»£ç 
```rust
// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

// å®šä¹‰ä¸€ä¸ªåä¸º Counter çš„åˆçº¦
contract Counter {
    // å®šä¹‰ä¸€ä¸ªå…¬å…±çš„ uint256 ç±»å‹çš„çŠ¶æ€å˜é‡ number
    uint256 public number;

    // å®šä¹‰ä¸€ä¸ªå…¬å…±å‡½æ•° setNumberï¼Œç”¨äºè®¾ç½® number çš„å€¼
    function setNumber(uint256 newNumber) public {
        number = newNumber; // å°†ä¼ å…¥çš„æ–°å€¼èµ‹ç»™ number
    }

    // å®šä¹‰ä¸€ä¸ªå…¬å…±å‡½æ•° incrementï¼Œç”¨äºå°† number çš„å€¼åŠ  1
    function increment() public {
        number++; // å°† number çš„å€¼åŠ  1
    }
}

```


### æµ‹è¯•
- å¸¸è§„æµ‹è¯•
- æ¨¡ç³Šæµ‹è¯•


#### æ¢ç´¢æµ‹è¯•ç±»å‹

- åœ¨**å¸¸è§„æµ‹è¯•**ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯æ¥æ”¶è®¡æ•°å™¨åˆçº¦å¹¶å°†å…¶é€’å¢ï¼Œä»¥ç¡®ä¿è®¡æ•°å™¨æ•°é‡ç­‰äº1ã€‚
- ç„¶è€Œï¼Œ**Fuzzæµ‹è¯•**æ¶‰åŠå‘æˆ‘ä»¬çš„æµ‹è¯•ä¼ é€’ä¸€ä¸ªéšæœºæ•°ã€‚

ä½¿ç”¨ä¸åŒçš„éšæœºæ•°ï¼Œä»¥ä¸€å®šçš„è¿è¡Œæ¬¡æ•°è¿è¡Œæ­¤æµ‹è¯•ã€‚æ— è®ºé€‰æ‹©Xçš„å€¼ï¼Œæµ‹è¯•å°†å§‹ç»ˆä¿æŒã€‚

æˆ‘ä»¬å¦‚ä½•æ”¹å˜æ¨¡ç³Šè¿è¡Œçš„æ¬¡æ•°ï¼Ÿåªéœ€æµè§ˆåˆ°Foundryçš„TOMLæ–‡ä»¶å¹¶å¤åˆ¶å˜é‡ã€‚
```rust
[fuzz]
runs = 256
max_test_rejects = 65536
seed = "0x3e8"
dictionary_weight = 40
include_storage = true
include_push_bytes = true
```
åœ¨TOMLæ–‡ä»¶ä¸­ï¼Œå¯ä»¥è®¾ç½®è¯•éªŒæ¬¡æ•°ã€‚ä¾‹å¦‚ï¼Œå°†å…¶ä»256æ›´æ”¹ä¸º600ã€‚![](media/Pasted%20image%2020250122165527.png)  
```rust
$ forge test
```
è¿™ä¸ªæµ‹è¯•Fuzzè¿è¡Œäº†600æ¬¡ã€‚è¿™è¡¨æ˜æµ‹è¯•ä½¿ç”¨äº†600ä¸ªä¸åŒçš„éšæœºæ•°ã€‚![](media/Pasted%20image%2020250122165508.png) 
## Fuzzing and invariants

### ä»€ä¹ˆæ˜¯æ¨¡ç³Šæµ‹è¯•ï¼Ÿ

**FUZZ**ä¹Ÿè¢«ç§°ä¸º**fuzzing**ï¼Œè¿™æ˜¯æ‰€æœ‰å…³äºæä¾›éšæœºæ•°æ®åˆ°æ‚¨çš„ç³»ç»Ÿï¼Œè¯•å›¾ç ´åå®ƒã€‚æƒ³è±¡ä½ çš„ä»£ç æ˜¯ä¸€ä¸ªåšä¸å¯æ‘§çš„æ°”çƒã€‚Fuzzingæ¶‰åŠæ‚¨å¯¹æ°”çƒåšéšæœºçš„äº‹æƒ…ï¼ˆå¦‚æˆ³ï¼ŒæŒ¤å‹ï¼Œç”šè‡³è¸¢ï¼‰ï¼Œç›®çš„æ˜¯æ‰“ç ´å®ƒã€‚

1. ç†è§£ä¸å˜é‡
2. ä¸ºä¸å˜é‡å†™fuzzæµ‹è¯•

### åŸºæœ¬åŸåˆ™ï¼šæµ‹è¯•ä¸å˜é‡ï¼ˆInvariantsï¼‰

æ¯ä¸ªç³»ç»Ÿï¼Œä»å‡½æ•°åˆ°æ•´ä¸ªç¨‹åºï¼Œéƒ½æœ‰ä¸€ä¸ªå®Œæ•´çš„å±æ€§ï¼Œé€šå¸¸è¢«ç§°ä¸º`Invariants`ã€‚æ­¤å±æ€§å¿…é¡»å§‹ç»ˆä¸ºçœŸã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥æœ‰ä¸€ä¸ªåä¸º`doStuff`çš„å‡½æ•°ï¼Œå®ƒåº”è¯¥æ€»æ˜¯è¿”å›é›¶ï¼Œè€Œä¸ç®¡è¾“å…¥çš„å€¼æ˜¯ä»€ä¹ˆã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿”å›é›¶å°†æ˜¯è¯¥å‡½æ•°çš„ä¸å˜é‡(`Invariants`)ã€‚

è®©æˆ‘ä»¬æ›´æ·±å…¥åœ°äº†è§£è¿™æ ·ä¸€ä¸ªå‡½æ•°å¯èƒ½æ˜¯ä»€ä¹ˆæ ·å­ï¼š
```rust
function doStuff(uint256 data) public {
Â  Â  Â  Â  if (data == 2){ // å¦‚æœdataç­‰äº2ï¼Œåˆ™è®¾ç½®shouldAlwaysBeZeroä¸º1
Â  Â  Â  Â  Â  Â  shouldAlwaysBeZero = 1;
Â  Â  Â  Â  }
Â  Â  Â  Â  if(hiddenValue == 7) { // å¦‚æœhiddenValueç­‰äº7ï¼Œåˆ™è®¾ç½®shouldAlwaysBeZeroä¸º1
Â  Â  Â  Â  Â  Â  shouldAlwaysBeZero = 1;
Â  Â  Â  Â  }
Â  Â  Â  Â  hiddenValue = data; // è®¾ç½®hiddenValueçš„å€¼ä¸ºdata
Â  Â  }
}
```
![](media/Pasted%20image%2020250122171632.png)  

è¿™ä¸ªå‡½æ•°çš„å•å…ƒæµ‹è¯•çœ‹èµ·æ¥åƒè¿™æ ·ï¼š![](media/Pasted%20image%2020250122171615.png)  
```rust
// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import {MyContract} from "../script/MyContract.sol";

contract MyContractTest {
    MyContract exampleContract; // å£°æ˜ MyContract ç±»å‹çš„å˜é‡ exampleContract
    
    // æµ‹è¯•å‡½æ•°ï¼ŒéªŒè¯ exampleContract çš„ shouldAlwaysBeZero å‡½æ•°æ˜¯å¦æ€»æ˜¯è¿”å› 0
    function testIAlwaysGetZero() public {
        uint256 data = 0; // åˆå§‹åŒ–æ•°æ®ä¸º 0
        exampleContract.doStuff(data); // è°ƒç”¨ exampleContract çš„ doStuff å‡½æ•°
        assert(exampleContract.shouldAlwaysBeZero() == 0); // æ–­è¨€ shouldAlwaysBeZero å‡½æ•°çš„è¿”å›å€¼ä¸º 0
    }
}
```
ä¸Šé¢çš„æµ‹è¯•ä¼šé€šè¿‡ï¼Œå› ä¸ºåœ¨ç‰¹å®šçš„æƒ…å†µä¸‹ï¼ˆ`data == 0`ï¼‰ï¼Œæˆ‘ä»¬çš„ä¸å˜é‡æ²¡æœ‰è¢«ç ´åã€‚

1. `data=0` æ—¶ ï¼Œæµ‹è¯•`forge test --match-test testIAlwaysGetZero` æˆåŠŸ![](media/Pasted%20image%2020250122172717.png)  
2. `data=1`![](media/Pasted%20image%2020250122172759.png)  


>å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªçœ‹èµ·æ¥ç¨å¾®å¤æ‚ä¸€ç‚¹çš„åŠŸèƒ½æ€ä¹ˆåŠï¼Ÿä¸ºæ¯ä¸ªåœºæ™¯ç¼–å†™æµ‹è¯•ç”¨ä¾‹å¯èƒ½å¾ˆä¹å‘³æˆ–ä¸å¯èƒ½ã€‚æˆ‘ä»¬éœ€è¦é‡‡å–æ›´å…·ç¨‹åºæ€§çš„æ–¹æ³•æ¥å…¨é¢æµ‹è¯•è¿™äº›æ¡ˆä¾‹ã€‚
###  Fuzz Tests and Invariant Tests

å¤„ç†è¿™ç§æƒ…å†µæ—¶æœ‰ä¸¤ç§æµè¡Œçš„æ–¹æ³•ï¼šä½¿ç”¨`fuzz`æµ‹è¯•/`ä¸å˜æµ‹è¯•`æˆ–`symbolic execution`

>"Fuzz testing and Invariant testing are great tools to assess the robustness of your code."

è®©æˆ‘ä»¬è€ƒè™‘Foundryä¸­æ¨¡ç³Šæµ‹è¯•çš„ä¸€ä¸ªç¤ºä¾‹ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åœ¨æµ‹è¯•å‚æ•°ä¸­æ­£ç¡®è®¾ç½®æ•°æ®ï¼Œä½¿Foundryèƒ½å¤Ÿè‡ªåŠ¨åŒ–æµ‹è¯•æœŸé—´æä¾›éšæœºè¾“å…¥æ•°æ®çš„è¿‡ç¨‹ã€‚
```rust
function testIsAlwaysGetZeroFuzz(uint256 data) public {
    exampleContract.doStuff(data);
    assert(exampleContract.shouldAlwaysBeZero() == 0);
}
```

![](media/Pasted%20image%2020250122173206.png)  
Foundryå°†è‡ªåŠ¨éšæœºåŒ–æ•°æ®å¹¶ä½¿ç”¨å¤§é‡ç¤ºä¾‹æ¥è¿è¡Œæµ‹è¯•è„šæœ¬ã€‚æ­¤æµ‹è¯•å°†æä¾›ä»0åˆ°`uint256.maxï¼ˆï¼‰`çš„éšæœºæ•°æ®ï¼Œæ¬¡æ•°ä¸æ‚¨é…ç½®çš„è¿è¡Œæ¬¡æ•°ç›¸åŒã€‚
>æé†’ï¼šæ‚¨å¯ä»¥åœ¨`foundation.toml`ä¸‹åœ¨ä¸­é…ç½®`[fuzz]`å˜é‡è¿è¡Œæ¬¡æ•°![](media/Pasted%20image%2020250122173254.png)  



>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§ä¼ªéšæœºæœºåˆ¶å¹¶ä¸è¯¦å°½ã€‚å®ƒä¸ä¼šä¸ºæ¯ä¸ªå¯èƒ½çš„æ•°æ®è¾“å…¥æä¾›åœºæ™¯ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿›ä¸€æ­¥äº†è§£Fuzzerå¦‚ä½•ç”Ÿæˆéšæœºæ•°æ®è‡³å…³é‡è¦ã€‚

### æ— çŠ¶æ€æ¨¡ç³Šä¸æœ‰çŠ¶æ€æ¨¡ç³Š

- ä¸Šé¢æ˜¯â€œæ— çŠ¶æ€æ¨¡ç³Šâ€`Stateless Fuzzing`çš„ä¸€ä¸ªä¾‹å­ã€‚
	- ç¼ºé™·ï¼š
		- ä¸Šä¸ªä¾‹å­ä¸­ å¦‚æœ`data=7` é‚£ä¸‹ä¸€æ¬¡è°ƒç”¨privateæ—¶`hiddenValue=7`ï¼Œåˆ™æ­¤æ—¶`shouldAlwaysBeZero!=0`![](media/Pasted%20image%2020250122174418.png)
		- ä½†æˆ‘ä»¬ä½¿ç”¨æ— çŠ¶æ€æ¨¡ç³Šæµ‹è¯•æ—¶å®ƒæ£€æµ‹ä¸åˆ°ï¼ˆå› ä¸ºå®ƒä¸ä¼šä¿å­˜ä¸Šä¸€ä¸ªçŠ¶æ€çš„ï¼‰![](media/Pasted%20image%2020250122174639.png)  
- å¦ä¸€ä¸ªå€¼å¾—ç†è§£çš„æ˜¯â€œçŠ¶æ€æ¨¡ç³ŠåŒ–â€ã€‚
	- â€œçŠ¶æ€æ¨¡ç³Šâ€`Stateful Fuzzing`ä¸ä¼šä¸ºæ¯æ¬¡æ–°è¿è¡Œé‡ç½®åˆåŒçŠ¶æ€ï¼Œè€Œæ˜¯å°†ä¸Šä¸€æ¬¡è¿è¡Œçš„ç»“æŸçŠ¶æ€ç”¨ä½œä¸‹ä¸€æ¬¡è¿è¡Œçš„å¼€å§‹çŠ¶æ€ã€‚   

çŠ¶æ€æ¨¡ç³Šæµ‹è¯•å°†åˆ©ç”¨æˆ‘ä»¬åˆšåˆšè§¦å‘çš„ç›¸åŒå¥‘çº¦å¹¶è°ƒç”¨å…¶ä¸­çš„å¦ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨å•æ¬¡è¿è¡Œä¸­åˆ›å»ºè¿é”çš„å‡½æ•°åºåˆ—ã€‚åœ¨Foundryä¸­å®ç°è¿™ä¸€ç‚¹éœ€è¦ä½¿ç”¨`invariant`å…³é”®å­—å’Œä¸€äº›è®¾ç½®ï¼š 

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä»`forge-std`å¯¼å…¥`StdInvariant`
```rust
//SPDX-License-Identifier: MIT
pragma solidity ^0.8.0

import {StdInvariant} from "forge-std/StdInvariant.sol";

contract MyContractTest is StdInvariant, Test {...}
```

ç„¶åï¼Œåœ¨è®¾ç½®æµ‹è¯•åˆåŒæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰Foundryï¼Œæˆ‘ä»¬å°†åœ¨å“ªä¸ªåˆåŒä¸Šè°ƒç”¨éšæœºå‡½æ•°ã€‚
```rust
function setUp() public {
    exampleContract = new MyContract();
    targetContract(address(exampleContract));
}
```
ç°åœ¨æˆ‘ä»¬çš„â€œæœ‰çŠ¶æ€æ¨¡ç³Šâ€æµ‹è¯•çœ‹èµ·æ¥åƒè¿™æ ·ï¼š
```rust
function invariant_testAlwaysReturnsZero() public {
    assert(exampleContract.shouldAlwaysBeZero() == 0);
}
```
é€šè¿‡ä¸Šè¿°æµ‹è¯•ï¼ŒFoundryå°†åœ¨`targetContract`ä¸Šè°ƒç”¨éšæœºå‡½æ•°ï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œé‡å¤è°ƒç”¨`doStuff`ï¼Œä½†å¦‚æœè¿˜æœ‰å…¶ä»–å‡½æ•°ï¼Œåˆ™å°†ä»¥éšæœºé¡ºåºè°ƒç”¨å®ƒä»¬ï¼‰å¹¶å‘è¿™äº›å‡½æ•°ä¼ é€’éšæœºæ•°æ®ã€‚
![](media/Pasted%20image%2020250122184108.png)  
```rust
// SPDX-License-Identifier: UNLICENSED

pragma solidity ^0.8.13;

import {MyContract} from "../script/MyContract.sol";
import {Test} from "forge-std/Test.sol";
import {StdInvariant} from "forge-std/StdInvariant.sol";

  

contract MyContractTest is StdInvariant, Test {
Â  Â  MyContract exampleContract; // å£°æ˜ MyContract ç±»å‹çš„å˜é‡ exampleContract

Â  Â  function setUp() public {
Â  Â  Â  Â  exampleContract = new MyContract(); // åˆå§‹åŒ– exampleContract å˜é‡
Â  Â  Â  Â  address targetContract = address(exampleContract); // è®¾ç½® targetContract ä¸º exampleContract çš„åœ°å€
Â  Â  }

Â  Â  function invariant_ShouldAlwaysBeZero() public Â {
Â  Â  Â  Â  assert(exampleContract.shouldAlwaysBeZero() == 0); // æ–­è¨€ exampleContract.shouldAlwaysBeZero() çš„å€¼ä¸º0
Â  Â  }

  

}
```



## Installing Libraries

